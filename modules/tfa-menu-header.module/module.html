{#
Module: TFA Menu Header - ULTRA COMPLETO
Description: Renders the primary navigation + Optional CTA with advanced style mapping.
#}

{% set style_mode = module.menu_settings.header_style_override %}
{% if style_mode == "default" or !style_mode %}
{% set style_mode = theme.header_settings.header_style %}
{% endif %}

<div class="tfa-header-module tfa-menu-header-wrapper" data-header-style="{{ style_mode }}">
    <div class="tfa-header-menu-container">

        <div class="tfa-navigation">
            {# Standard HubSpot menu #}
            {% menu
            id="{{ module.menu_settings.navigation_menu }}"
            root_key="{{ module.menu_settings.navigation_menu }}"
            %}
        </div>

        {% if module.cta_settings.show_cta %}
        <div class="tfa-header-cta-wrapper">
            <a href="{{ module.cta_settings.cta_link.url.href }}"
                class="tfa-button tfa-button--primary tfa-button--small">
                {{ module.cta_settings.cta_text }}
            </a>
        </div>
        {% endif %}

    </div>
</div>

{# Script to toggle header style classes #}
<script>
    (function () {
        const ALL_STYLES = [
            'header--glassmorphism',
            'header--glassmorphism_dark',
            'header--solid_white',
            'header--solid_black',
            'header--transparent_light',
            'header--transparent_dark',
            'header--minimal'
        ];

        function updateHeaderStyle() {
            const dataElement = document.querySelector('.tfa-header-module');
            let headerElement = document.querySelector('.header');

            if (!headerElement && window.parent) {
                try {
                    headerElement = window.parent.document.querySelector('.header');
                } catch (e) { }
            }

            if (dataElement) {
                const style = dataElement.getAttribute('data-header-style');

                const applyTo = (el) => {
                    if (!el) return;
                    requestAnimationFrame(() => {
                        el.classList.remove(...ALL_STYLES);
                        if (style && style !== 'default') {
                            el.classList.add('header--' + style);
                        }
                    });
                };

                applyTo(headerElement);
                applyTo(dataElement);
            }
        }

        function init() {
            updateHeaderStyle();
            const dataElement = document.querySelector('.tfa-header-module');
            if (dataElement) {
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'data-header-style') {
                            updateHeaderStyle();
                        }
                    });
                });
                observer.observe(dataElement, { attributes: true, attributeFilter: ['data-header-style'] });
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        window.addEventListener('message', (event) => {
            if (event.data && (event.data.type === 'hubspot:editor:refresh' || event.data.action === 'inline-edit-finish')) {
                setTimeout(updateHeaderStyle, 100);
            }
        });
    })();
</script>